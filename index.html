
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>A Computer Science blog  | Zeus@HackOlympus:~$</title>

	<meta name="author" content="Zeus"> 
	
	<meta name="description" content="Before reading this, it&rsquo;s an advice to please read previous article of ASM series. So now that we know some basics of registers and syscalls. &hellip;"> <meta name="keywords" content="">
    
    <meta name="keywords" content="" />

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Zeus@HackOlympus:~$" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	
</head>



<body>
	<header id="header" class="inner"><a href="/"><h1>Zeus@HackOlympus:~$</h1></a>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/contact">Contact</a></li>
</ul>
</nav>


</header>

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2022/01/04/writing-programs-in-x86-64-assembly-language/">
		
			Writing Programs in X86-64 ASM and Pwncollege Embryoasm Writeup</a>
	</h2>
	<div class="entry-content">
		<p>Before reading this, it&rsquo;s an advice to please read <a href="/blog/2021/11/25/x86-64-assembly-language/">previous article</a> of ASM series.</p>

<p>So now that we know some basics of registers and syscalls. We will move onto the part where we use our newfound knowledge to write some assembly code.</p>

<p><strong>The following ASM code is specific to GAS (GNU Assembler)</strong></p>

<h3>Step by Step Hello world ASM program breakdown</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="na">.section</span> <span class="no">.text</span>
</span><span class='line'>    <span class="na">.intel_syntax</span> <span class="no">noprefix</span>
</span><span class='line'>    <span class="na">.global</span> <span class="no">_start</span>
</span><span class='line'>    <span class="nl">_start:</span>
</span><span class='line'>        <span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'>        <span class="nf">lea</span> <span class="no">rsi</span><span class="p">,</span> <span class="err">[</span><span class="no">rip</span><span class="err">+</span><span class="no">str</span><span class="err">]</span>
</span><span class='line'>        <span class="nf">mov</span> <span class="no">rdx</span><span class="p">,</span> <span class="mi">13</span>
</span><span class='line'>        <span class="nf">syscall</span>
</span><span class='line'>
</span><span class='line'>        <span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">60</span>
</span><span class='line'>        <span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>        <span class="nf">syscall</span>
</span><span class='line'>
</span><span class='line'>    <span class="nl">str:</span>
</span><span class='line'>        <span class="na">.string</span> <span class="s">&quot;Hello world\n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now in my <a href="/blog/2021/01/24/Memory-Mapping-Introduction/">first article</a>, I explained different sections/mapping of memory. Most important sections among those are <code>.text</code> section and <code>.data</code>, because it is <code>.text</code> where we write code and <code>.data</code> where we define variables and constants.</p>

<p>In the above <em>hello world</em> program, we are only using the <code>.text</code> section and keeping the code as minimal and simple as possible.</p>

<p>So in the first line we are defining the section. In order to define a section we do <code>.section &lt;section name&gt;</code></p>

<p>In our case, as we are only using <code>.text</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="na">.section</span> <span class="no">.text</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now because we are using GAS, the default ASM sytax is AT&amp;T but we are writing in intel syntax so we need to specify that to the assembler. We do this using :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="na">.intel_syntax</span> <span class="no">noprefix</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p><code>.global</code> is GAS directive which helps in defining symbols in object file. Every ASM code must have a <code>_start</code> symbol. It defines the entry point of ASM code.</p>

<p>In GAS we do all this using :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="na">.global</span> <span class="no">_start</span> <span class="c"># first we define a symbol</span>
</span><span class='line'><span class="nf">_start</span> <span class="p">:</span> <span class="c"># then we mark the entry point </span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Oh ! by the way, we use <code>#</code> in GAS for comments.</p>

<h3>MOV instruction</h3>

<p>The <code>mov</code> instruction is the very basic and is used extensively in a assembly program.  It is used to copy/move data from one register to another. In intel, it works in the following way :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">mov</span> <span class="err">&lt;</span><span class="no">destination</span> <span class="no">register</span><span class="err">&gt;</span> <span class="p">,</span> <span class="err">&lt;</span><span class="no">source</span> <span class="no">register</span><span class="err">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>For example we need to copy number 6263 in register <code>rax</code>, We&rsquo;ll do :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">6263</span> <span class="c"># rax = 6263</span>
</span></code></pre></td></tr></table></div></figure>


<h3>LEA instruction</h3>

<p>The <code>lea</code> instruction is used to copy some <strong>address</strong> in some register.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">lea</span> <span class="err">&lt;</span><span class="no">destination</span> <span class="no">register</span><span class="err">&gt;</span> <span class="p">,</span> <span class="err">&lt;</span><span class="no">source</span> <span class="no">effective</span> <span class="no">address</span><span class="err">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
This is also used extensively because we are loading effective address, So we can also do math in one instruction itself and assembler will understand it and assemble it for us. In <code>mov</code> instruction it&rsquo;s not possible.</p>

<h3>SYSCALL instruction</h3>

<p>syscall instruction, as name says, is used for making system calls.</p>

<h3>Main Hello world code</h3>

<p>Now to write something on screen, we need to write on stdout (it&rsquo;s file descriptor is 1). So in total we need to do 2 syscalls (write and exit syscalls).</p>

<p>To do write syscall we need to give it some arguments. We give arguments based on calling convention (Discussed in previous <a href="/blog/2021/11/25/x86-64-assembly-language/">article</a>) .</p>

<p><img src="/images/x86-64/Calling_convention.png" class="center" style="width: 60%"></p>

<p>We can either use a good <a href="https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md">website</a> or if you are a console fan then method used in <a href="/blog/2021/11/25/x86-64-assembly-language/">previous article</a> to get syscall number and to see arguments use 2nd page of <code>man</code> command.</p>

<p><img src="/images/x86-64/man_write.png" class="center" style="width: 90%"></p>

<p><code>echo SYS_write | gcc -include sys/syscall.h -E -</code></p>

<p>So, putting everything together and writing a subroutine for <code>write</code> syscall</p>

<p><strong>1st argument :</strong> fd (File descriptor which in our case is 1 for stdout) <br>
<strong>2nd argument :</strong> buf (Buffer, Address of info which has to be written on screen ?) <br>
<strong>3rd argument :</strong> count (Buffer size) <br></p>

<p>All these arguments have to be set according to calling convention.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">1</span>         <span class="c"># syscall code is set through rax register </span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">1</span>         <span class="c"># set fd to stdout (1)  </span>
</span><span class='line'><span class="nf">lea</span> <span class="no">rsi</span><span class="p">,</span> <span class="err">[</span><span class="no">rip</span><span class="err">+</span><span class="no">str</span><span class="err">]</span> <span class="c"># use rip (instruction pointer) to access label str</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rdx</span><span class="p">,</span> <span class="mi">13</span>        <span class="c"># Hello world\n\0 size = 13</span>
</span><span class='line'><span class="nf">syscall</span>            <span class="c"># perform syscall </span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Label <code>str</code> is basically a space in memory where &ldquo;hello world&rdquo; is stored in form of bytes. <code>lea</code> instruction will calculate the address of the start of buffer using <code>rip</code> register (instruction pointer).</p>

<p>I recommend you to write the <code>exit</code> subroutine without looking at my code.</p>

<p><strong>Exit subroutine :</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">60</span> <span class="c"># syscall code for exit is 60 </span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">0</span>  <span class="c"># return address of exit </span>
</span><span class='line'><span class="nf">syscall</span>     <span class="c"># perform syscall </span>
</span></code></pre></td></tr></table></div></figure>


<p>So to putting all the pieces together and we get our assembly code :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="na">.section</span> <span class="no">.text</span>
</span><span class='line'>    <span class="na">.intel_syntax</span> <span class="no">noprefix</span>
</span><span class='line'>    <span class="na">.global</span> <span class="no">_start</span>
</span><span class='line'>    <span class="nl">_start:</span>
</span><span class='line'>        <span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'>        <span class="nf">lea</span> <span class="no">rsi</span><span class="p">,</span> <span class="err">[</span><span class="no">rip</span><span class="err">+</span><span class="no">str</span><span class="err">]</span>
</span><span class='line'>        <span class="nf">mov</span> <span class="no">rdx</span><span class="p">,</span> <span class="mi">13</span>
</span><span class='line'>        <span class="nf">syscall</span>
</span><span class='line'>
</span><span class='line'>        <span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">60</span>
</span><span class='line'>        <span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>        <span class="nf">syscall</span>
</span><span class='line'>
</span><span class='line'>    <span class="nl">str:</span>
</span><span class='line'>        <span class="na">.string</span> <span class="s">&quot;Hello world\n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope after reading this, you would have understood assembly and basic concepts related to memory. Now like any other language, assembly is just about practice, pratice and practice. Once you master it, I guarantee, assembly and C will become your favorite language.</p>

<h3><a href="https://dojo.pwn.college/challenges/asm">Pwn.College Embryoasm</a>  Writeup</h3>

<p>I have already started the instance, so let' connnect <code>ssh -i ~/.ssh/key.pub hacker@dojo.pwn.college</code> .</p>

<p><img src="/images/x86-64/asm_1.png" class="center" style="width: 90%"></p>

<p>So this is easy. As explained above. We can just do <code>mov rdi, 0x1337</code></p>

<p>full code :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="na">.section</span> <span class="no">.text</span>
</span><span class='line'>    <span class="no">.intel_syntax</span> <span class="no">noprefix</span>
</span><span class='line'>    <span class="no">.global</span> <span class="no">_start</span>
</span><span class='line'>    <span class="no">_start</span> <span class="p">:</span>
</span><span class='line'>        <span class="no">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">0x1337</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we assemble it and compile it into an ELF then we will convert copy bytes of that ELF in a different file.</p>

<p>to do so :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">gcc</span> <span class="p">-</span><span class="no">nostdlib</span> <span class="p">-</span><span class="no">static</span> <span class="no">exp.s</span> <span class="p">-</span><span class="no">o</span> <span class="no">exp</span>
</span><span class='line'><span class="nf">objcopy</span> <span class="p">--</span><span class="no">dump-section</span> <span class="no">.text</span><span class="err">=</span><span class="no">exp.bin</span> <span class="no">exp</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we will pipe the bytes into the challenge.</p>

<p><img src="/images/x86-64/asm_1_flag.png" class="center" style="width: 90%"></p>

<p>We can also do this using python script through pwntools.</p>

<p>Python script :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c">#!/usr/bin/env python3</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pwn</span>
</span><span class='line'><span class="n">pwn</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">&quot;INFO&quot;</span>
</span><span class='line'><span class="n">pwn</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">&quot;latin&quot;</span>
</span><span class='line'><span class="n">pwn</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s">&quot;amd64&quot;</span>
</span><span class='line'><span class="n">pwn</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">assembly</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;mov rdi, 0x1337&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">proc</span> <span class="o">=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s">&quot;/challenge/embryoasm_level1&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">readrepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span><span class='line'><span class="n">proc</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">pwn</span><span class="o">.</span><span class="n">asm</span><span class="p">(</span><span class="n">assembly</span><span class="p">))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">readrepeat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>In future I&rsquo;ll write some interesting articles on some more instructions in ASM, file operations through assembly, shellcoding and operating system design.</p>

<p>A <a href="https://deut-erium.github.io/about.html">wise man</a>👨‍💻 (check out his <a href="https://deut-erium.github.io/">blog</a>) once said to me, &ldquo;its almost like playing lego &hellip; you have to put the pieces together &hellip;&rdquo;</p>

<p>On that note,</p>

<p>Signing out</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  



<time datetime="2022-01-04T15:28:24+05:30" pubdate data-updated="true">Jan 4th, 2022</time></div>
	

<div class="tags">

	<a class='category' href='//blog/categories/asm/'>asm</a>

</div>


</div>
</article>


<nav id="pagenavi">
    
    
        <a href="2" class="next">Next</a>
    
</nav>

</div>
	<footer id="footer" class="inner">Copyright &copy; 2022
 Zeus 
<br>
</footer>
	

</body>
</html>
